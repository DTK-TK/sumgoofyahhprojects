<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sudoku Solver â€” Backtracking + Quantum Analysis</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600;700&family=Syne:wght@400;700;800&display=swap');

:root {
  --bg:#08090d;--surf:#0f1016;--panel:#13141c;--border:#1e2030;--border2:#2a2d45;
  --accent:#4fffb0;--accent2:#ff6b6b;--accent3:#ffd93d;--blue:#5c9dff;--purple:#b06dff;
  --text:#dde1f0;--muted:#555878;--dim:#383b55;--given-col:#7ea8ff;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:'IBM Plex Mono',monospace;
  min-height:100vh;padding:24px 16px 48px;
  background-image:radial-gradient(ellipse 80% 50% at 10% 5%,rgba(79,255,176,.03) 0%,transparent 50%),
  radial-gradient(ellipse 60% 60% at 90% 90%,rgba(92,157,255,.03) 0%,transparent 50%)}

.header{text-align:center;margin-bottom:28px}
.header-title{font-family:'Syne',sans-serif;font-size:clamp(20px,3.5vw,32px);font-weight:800;letter-spacing:-.5px}
.header-title em{color:var(--accent);font-style:normal}
.header-sub{font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-top:5px}

.layout{display:grid;grid-template-columns:auto 1fr;gap:24px;max-width:1080px;margin:0 auto;align-items:start}
@media(max-width:760px){.layout{grid-template-columns:1fr}}

.left-col{display:flex;flex-direction:column;align-items:center;gap:14px}

/* difficulty */
.diff-strip{display:flex;gap:6px}
.diff-btn{font-family:'IBM Plex Mono',monospace;font-size:10px;letter-spacing:1.5px;text-transform:uppercase;
  padding:7px 14px;border-radius:5px;border:1px solid var(--border2);background:var(--panel);
  color:var(--muted);cursor:pointer;transition:all .15s;line-height:1.6}
.diff-btn:hover{color:var(--text);border-color:var(--dim)}
.diff-btn.sel-easy{border-color:var(--accent);color:var(--accent);background:rgba(79,255,176,.06)}
.diff-btn.sel-medium{border-color:var(--accent3);color:var(--accent3);background:rgba(255,217,61,.06)}
.diff-btn.sel-hard{border-color:var(--accent2);color:var(--accent2);background:rgba(255,107,107,.06)}

/* grid */
.sudoku-grid{display:grid;grid-template-columns:repeat(9,1fr);border:2px solid var(--border2);
  border-radius:8px;overflow:hidden;background:var(--border);gap:1px;
  box-shadow:0 0 0 1px var(--border),0 8px 40px rgba(0,0,0,.6);transition:box-shadow .4s}
.sudoku-grid.state-solving{box-shadow:0 0 30px rgba(79,255,176,.15)}
.sudoku-grid.state-solved{box-shadow:0 0 40px rgba(79,255,176,.3)}

.cell{width:52px;height:52px;display:flex;align-items:center;justify-content:center;
  font-size:19px;font-weight:600;background:var(--surf);color:var(--text);
  cursor:pointer;transition:background .1s,color .15s;user-select:none}
@media(max-width:520px){.cell{width:38px;height:38px;font-size:15px}}
.cell.rb{border-right:2px solid var(--border2)}
.cell.bb{border-bottom:2px solid var(--border2)}
.cell.given{color:var(--given-col);background:#0d0f18;cursor:default}
.cell.filled{color:var(--accent)}
.cell.active{background:#151a28;outline:2px solid var(--accent);outline-offset:-2px;z-index:2}
.cell.hi-box{background:#0e1018}
.cell.hi-same{color:var(--accent)!important}
.cell.anim-solve{animation:cellSolve .18s ease forwards}
@keyframes cellSolve{0%{background:#0f2520}100%{background:var(--surf)}}

/* controls */
.controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;align-items:center}
.btn{font-family:'IBM Plex Mono',monospace;font-size:11px;letter-spacing:1px;text-transform:uppercase;
  padding:9px 18px;border:1px solid var(--border2);border-radius:6px;background:var(--panel);
  color:var(--text);cursor:pointer;transition:all .14s}
.btn:hover:not(:disabled){border-color:var(--accent);color:var(--accent)}
.btn.primary{background:var(--accent);color:#020e08;border-color:var(--accent);font-weight:700}
.btn.primary:hover:not(:disabled){background:#38e89a}
.btn.stop{background:var(--accent2);color:#fff;border-color:var(--accent2);font-weight:700;display:none}
.btn.stop:hover:not(:disabled){background:#e05050}
.btn:disabled{opacity:.35;cursor:not-allowed}
.speed-row{display:flex;align-items:center;gap:7px}
.speed-row label{font-size:10px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted)}
select{font-family:'IBM Plex Mono',monospace;font-size:11px;background:var(--surf);color:var(--text);
  border:1px solid var(--border2);border-radius:5px;padding:5px 8px;cursor:pointer;outline:none}
select:focus{border-color:var(--accent)}

/* numpad */
.numpad{display:grid;grid-template-columns:repeat(5,1fr);gap:5px;width:100%}
.num-btn{font-family:'IBM Plex Mono',monospace;font-size:15px;font-weight:500;padding:9px 0;
  border:1px solid var(--border2);border-radius:5px;background:var(--surf);color:var(--text);
  cursor:pointer;transition:all .1s;text-align:center}
.num-btn:hover{border-color:var(--accent);color:var(--accent);background:#0a1510}
.num-btn.del{font-size:11px;letter-spacing:.5px;color:var(--muted)}
.num-btn.del:hover{color:var(--accent2);border-color:var(--accent2)}

/* right col */
.right-col{display:flex;flex-direction:column;gap:14px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:18px 20px}
.card-title{font-size:10px;font-weight:600;letter-spacing:2.5px;text-transform:uppercase;
  color:var(--muted);margin-bottom:14px;padding-bottom:10px;border-bottom:1px solid var(--border)}

/* iter */
.iter-big{font-family:'Syne',sans-serif;font-size:clamp(28px,4vw,42px);font-weight:800;
  color:var(--accent);letter-spacing:-2px;font-variant-numeric:tabular-nums;line-height:1}
.iter-sub{font-size:10px;color:var(--muted);letter-spacing:2px;text-transform:uppercase;margin-top:4px}
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:1px;background:var(--border);border-radius:7px;overflow:hidden;margin-top:14px}
.stat-box{background:var(--surf);padding:12px 14px}
.stat-box .s-label{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted)}
.stat-box .s-val{font-size:14px;font-weight:600;margin-top:4px}
.s-val.green{color:var(--accent)}.s-val.yellow{color:var(--accent3)}
.s-val.red{color:var(--accent2)}.s-val.blue{color:var(--blue)}.s-val.purple{color:var(--purple)}

/* progress */
.progress-wrap{margin-top:12px}
.progress-label{display:flex;justify-content:space-between;font-size:10px;color:var(--muted);
  letter-spacing:1px;text-transform:uppercase;margin-bottom:5px}
.progress-track{height:5px;background:var(--border);border-radius:3px;overflow:hidden}
.progress-fill{height:100%;border-radius:3px;transition:width .3s ease;
  background:linear-gradient(90deg,var(--accent),var(--blue));width:0%}

/* search space */
.search-row{display:flex;justify-content:space-between;align-items:flex-start;padding:9px 0;
  border-bottom:1px solid var(--border);font-size:11px;gap:8px}
.search-row:last-child{border-bottom:none}
.sr-label{color:var(--muted);flex-shrink:0}.sr-val{font-weight:600;text-align:right;word-break:break-all}

/* quantum */
.q-formula{font-size:11px;color:var(--muted);line-height:2.1;padding:10px 12px;
  background:var(--surf);border-radius:6px;border:1px solid var(--border);margin-bottom:12px}
.q-formula .f{color:var(--text)}.q-formula .v{color:var(--accent);font-weight:600}
.q-formula .v2{color:var(--accent3);font-weight:600}
.speedup-bar-row{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.sb-label{font-size:10px;color:var(--muted);width:90px;flex-shrink:0}
.sb-track{flex:1;height:7px;background:var(--border);border-radius:4px;overflow:hidden}
.sb-fill{height:100%;border-radius:4px;transition:width .9s cubic-bezier(.4,0,.2,1)}
.sb-fill.classical{background:linear-gradient(90deg,var(--accent3),var(--accent2))}
.sb-fill.quantum{background:linear-gradient(90deg,var(--accent),var(--blue))}
.sb-num{font-size:10px;color:var(--muted);width:60px;text-align:right}
.speedup-badge{display:inline-flex;align-items:center;gap:6px;
  background:rgba(79,255,176,.08);border:1px solid rgba(79,255,176,.25);border-radius:6px;
  padding:8px 14px;margin-top:8px;font-size:12px;color:var(--accent);font-weight:600}

/* IA table */
.ia-table{width:100%;border-collapse:collapse;font-size:10.5px}
.ia-table th{text-align:left;color:var(--muted);font-weight:500;letter-spacing:1px;padding:6px 8px;
  border-bottom:1px solid var(--border2);text-transform:uppercase;font-size:9px}
.ia-table td{padding:8px 8px;border-bottom:1px solid var(--border);vertical-align:top}
.ia-table tr:last-child td{border-bottom:none}
.td-label{color:var(--muted);width:130px}.td-val{color:var(--text);font-weight:500}
.td-acc{color:var(--accent);font-weight:600}.td-note{color:var(--muted);font-size:9.5px}

/* log */
.log-box{font-size:10.5px;color:var(--muted);line-height:1.9;max-height:130px;
  overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--border2) transparent}
.log-box .l-acc{color:var(--accent)}.log-box .l-warn{color:var(--accent3)}
.log-box .l-err{color:var(--accent2)}.log-box .l-info{color:var(--text)}
</style>
</head>
<body>

<div class="header">
  <div class="header-title">Sudoku <em>Backtracking</em> Solver</div>
  <div class="header-sub">The Greatest Sudoku Solver per Century :D</div>
</div>

<div class="layout">
  <!-- â•â•â• LEFT â•â•â• -->
  <div class="left-col">
    <div class="diff-strip">
      <button class="diff-btn" id="db-easy"   onclick="newPuzzle('easy')">Easy<br><span style="font-size:9px;opacity:.6">~40 clues</span></button>
      <button class="diff-btn" id="db-medium" onclick="newPuzzle('medium')">Medium<br><span style="font-size:9px;opacity:.6">~35 clues</span></button>
      <button class="diff-btn" id="db-hard"   onclick="newPuzzle('hard')">Hard<br><span style="font-size:9px;opacity:.6">~30 clues</span></button>
    </div>
    <div class="sudoku-grid" id="grid"></div>
    <div class="controls">
      <button class="btn primary" id="btn-solve" onclick="startSolve()">â–¶ Solve</button>
      <button class="btn stop"    id="btn-stop"  onclick="stopSolve()">â–  Stop</button>
      <button class="btn" onclick="resetToOriginal()">â†© Reset</button>
      <div class="speed-row">
        <label>Speed</label>
        <select id="speed-sel">
          <option value="0">Instant</option>
          <option value="1" selected>Fast</option>
          <option value="10">Slow</option>
          <option value="50">Step</option>
        </select>
      </div>
    </div>
    <div class="numpad" id="numpad"></div>
  </div>

  <!-- â•â•â• RIGHT â•â•â• -->
  <div class="right-col">
    <!-- LIVE COUNTER -->
    <div class="card">
      <div class="card-title">Live Iteration Counter</div>
      <div class="iter-big" id="iter-display">0</div>
      <div class="iter-sub">backtracking iterations</div>
      <div class="progress-wrap">
        <div class="progress-label">
          <span>Cells filled</span><span id="prog-pct">0%</span>
        </div>
        <div class="progress-track"><div class="progress-fill" id="prog-fill"></div></div>
      </div>
      <div class="stats-grid">
        <div class="stat-box"><div class="s-label">Status</div><div class="s-val green" id="s-status">Idle</div></div>
        <div class="stat-box"><div class="s-label">Backtracks</div><div class="s-val red" id="s-bt">0</div></div>
        <div class="stat-box"><div class="s-label">Solve Time</div><div class="s-val yellow" id="s-time">â€”</div></div>
        <div class="stat-box"><div class="s-label">Empty Cells (m)</div><div class="s-val blue" id="s-m">â€”</div></div>
      </div>
    </div>

    <!-- SEARCH SPACE -->
    <div class="card">
      <div class="card-title">Search Space Analysis</div>
      <div class="search-row"><span class="sr-label">Difficulty</span><span class="sr-val" id="ss-diff" style="color:var(--accent3)">â€”</span></div>
      <div class="search-row"><span class="sr-label">Given clues (n)</span><span class="sr-val" id="ss-n" style="color:var(--text)">â€”</span></div>
      <div class="search-row"><span class="sr-label">N.upper = 9^m</span><span class="sr-val" id="ss-nupper" style="color:var(--accent2)">â€”</span></div>
      <div class="search-row"><span class="sr-label">N.eff = 7.5^m</span><span class="sr-val" id="ss-neff" style="color:var(--accent3)">â€”</span></div>
      <div class="search-row"><span class="sr-label">Classical E[iter] = N.upper/2</span><span class="sr-val" id="ss-class" style="color:var(--accent3)">â€”</span></div>
      <div class="search-row"><span class="sr-label">Empirical iterations</span><span class="sr-val" id="ss-emp" style="color:var(--accent)">â€”</span></div>
    </div>

    <!-- GROVER -->
    <div class="card">
      <div class="card-title">Grover's Algorithm (Theoretical)</div>
      <div class="q-formula">
        Î¸ = arcsin(1/âˆšN.eff) = <span class="v" id="qf-theta">â€”</span> rad<br>
        k_opt = âŒŠ(Ï€/4)Â·âˆšN.effâŒ‹ = <span class="v" id="qf-k">â€”</span> iterations<br>
        S = (2/Ï€)Â·âˆšN.eff â‰ˆ <span class="v2" id="qf-s">â€”</span>Ã— speedup
      </div>
      <div class="speedup-bar-row">
        <div class="sb-label">Classical</div>
        <div class="sb-track"><div class="sb-fill classical" id="bar-c" style="width:100%"></div></div>
        <div class="sb-num" id="bar-c-lbl">â€”</div>
      </div>
      <div class="speedup-bar-row">
        <div class="sb-label">Quantum (Grover)</div>
        <div class="sb-track"><div class="sb-fill quantum" id="bar-q" style="width:2%"></div></div>
        <div class="sb-num" id="bar-q-lbl">â€”</div>
      </div>
      <div class="speedup-badge">âš¡ <span id="qf-badge">Generate and solve a puzzle to see speedup</span></div>
    </div>

    <!-- IA TABLE -->
    <div class="card">
      <div class="card-title">IA Data Record â€” Table 3 Format</div>
      <table class="ia-table">
        <thead><tr><th>Field</th><th>Value</th><th>Notes</th></tr></thead>
        <tbody>
          <tr><td class="td-label">Puzzle ID</td><td class="td-val" id="ia-id">â€”</td><td class="td-note">Auto-generated</td></tr>
          <tr><td class="td-label">Difficulty</td><td class="td-val" id="ia-diff">â€”</td><td class="td-note">Easy / Medium / Hard</td></tr>
          <tr><td class="td-label">Given clues (n)</td><td class="td-val" id="ia-n">â€”</td><td class="td-note">Pre-filled cells</td></tr>
          <tr><td class="td-label">Empty cells (m)</td><td class="td-val" id="ia-m">â€”</td><td class="td-note">Search depth</td></tr>
          <tr><td class="td-label">Empirical Iterations</td><td class="td-acc" id="ia-emp">â€”</td><td class="td-note">Actual measured</td></tr>
          <tr><td class="td-label">N.eff / 2</td><td class="td-val" id="ia-neff2">â€”</td><td class="td-note">Theoretical avg classical</td></tr>
          <tr><td class="td-label">Grover k_opt</td><td class="td-val" id="ia-k">â€”</td><td class="td-note">âŒŠ(Ï€/4)âˆšN.effâŒ‹</td></tr>
          <tr><td class="td-label">Speedup Factor</td><td class="td-acc" id="ia-speedup">â€”</td><td class="td-note">Emp / k_opt</td></tr>
        </tbody>
      </table>
      <button class="btn" style="margin-top:12px;width:100%" onclick="copyIAData()">ðŸ“‹ Copy Row (Tab-separated)</button>
    </div>

    <!-- LOG -->
    <div class="card">
      <div class="card-title">Solver Log</div>
      <div class="log-box" id="log"></div>
    </div>
  </div>
</div>

<script>
  
#  PUZZLE GENERATOR â€” randomised valid unique Sudoku
function shuffle(a){
  for(let i=a.length-1;i>0;i--){const j=0|Math.random()*(i+1);[a[i],a[j]]=[a[j],a[i]]}
  return a;
}

function isOK(g,r,c,n){
  for(let i=0;i<9;i++){if(g[r][i]===n||g[i][c]===n)return false}
  const br=~~(r/3)*3,bc=~~(c/3)*3;
  for(let i=0;i<3;i++)for(let j=0;j<3;j++)if(g[br+i][bc+j]===n)return false;
  return true;
}

function generateFull(){
  const g=Array.from({length:9},()=>Array(9).fill(0));
  function fill(pos){
    if(pos===81)return true;
    const r=~~(pos/9),c=pos%9;
    for(const n of shuffle([1,2,3,4,5,6,7,8,9])){
      if(isOK(g,r,c,n)){g[r][c]=n;if(fill(pos+1))return true;g[r][c]=0}
    }
    return false;
  }
  fill(0);return g;
}

function countSols(g,limit=2){
  let cnt=0;
  function bt(pos){
    if(cnt>=limit)return;
    if(pos===81){cnt++;return}
    const r=~~(pos/9),c=pos%9;
    if(g[r][c]!==0){bt(pos+1);return}
    for(let n=1;n<=9;n++){
      if(isOK(g,r,c,n)){g[r][c]=n;bt(pos+1);g[r][c]=0;if(cnt>=limit)return}
    }
  }
  bt(0);return cnt;
}

function createPuzzle(diff){
  const full=generateFull();
  const puz=full.map(r=>[...r]);
  const targets={easy:40,medium:35,hard:30};
  let clues=81;
  for(const pos of shuffle([...Array(81).keys()])){
    if(clues<=targets[diff])break;
    const r=~~(pos/9),c=pos%9,bak=puz[r][c];
    puz[r][c]=0;
    const tmp=puz.map(r=>[...r]);
    if(countSols(tmp,2)!==1){puz[r][c]=bak}else{clues--}
  }
  return{puzzle:puz,solution:full,clues};
}

#  STATE
let board=[],givenMask=[],solution=[];
let selR=-1,selC=-1;
let iterations=0,backtracks=0,solvedCells=0,totalEmpty=0,finalIter=0;
let solving=false,abortFlag=false,startTime=0;
let currentDiff='easy',puzzleId=0;


//  GRID DOM
function buildGrid(){
  const g=document.getElementById('grid');g.innerHTML='';
  for(let r=0;r<9;r++)for(let c=0;c<9;c++){
    const d=document.createElement('div');
    d.className='cell'+(c===2||c===5?' rb':'')+(r===2||r===5?' bb':'');
    d.dataset.r=r;d.dataset.c=c;
    d.onclick=()=>select(r,c);
    g.appendChild(d);
  }
}

function cel(r,c){return document.querySelector(`.cell[data-r="${r}"][data-c="${c}"]`)}

function renderAll(){
  for(let r=0;r<9;r++)for(let c=0;c<9;c++){
    const el=cel(r,c),v=board[r][c];
    el.className='cell'+(c===2||c===5?' rb':'')+(r===2||r===5?' bb':'');
    el.textContent=v||'';
    if(givenMask[r][c])el.classList.add('given');
    else if(v)el.classList.add('filled');
    if(r===selR&&c===selC)el.classList.add('active');
  }
  if(selR>=0)applyHL(selR,selC);
}

function applyHL(r,c){
  const v=board[r][c];
  for(let i=0;i<9;i++)for(let j=0;j<9;j++){
    if(i===r&&j===c)continue;
    const el=cel(i,j);
    const sameBox=~~(i/3)===~~(r/3)&&~~(j/3)===~~(c/3);
    if(i===r||j===c||sameBox)el.classList.add('hi-box');
    if(v&&board[i][j]===v)el.classList.add('hi-same');
  }
}

function select(r,c){if(solving)return;selR=r;selC=c;renderAll()}

function buildNumpad(){
  const p=document.getElementById('numpad');p.innerHTML='';
  for(let i=1;i<=9;i++){
    const b=document.createElement('button');b.className='num-btn';b.textContent=i;
    b.onclick=()=>placeNum(i);p.appendChild(b);
  }
  const d=document.createElement('button');d.className='num-btn del';d.textContent='DEL';
  d.onclick=()=>placeNum(0);p.appendChild(d);
}

function placeNum(n){
  if(selR<0||solving||givenMask[selR][selC])return;
  board[selR][selC]=n;renderAll();
}

document.addEventListener('keydown',e=>{
  if(solving||selR<0)return;
  if(e.key>='1'&&e.key<='9')placeNum(+e.key);
  if(e.key==='Backspace'||e.key==='Delete')placeNum(0);
  const d={ArrowUp:[-1,0],ArrowDown:[1,0],ArrowLeft:[0,-1],ArrowRight:[0,1]}[e.key];
  if(d){selR=Math.max(0,Math.min(8,selR+d[0]));selC=Math.max(0,Math.min(8,selC+d[1]));renderAll();e.preventDefault()}
});

//  PUZZLE MANAGEMENT
function newPuzzle(diff){
  if(solving)stopSolve();
  currentDiff=diff;puzzleId++;
  addLog(`Generating ${diff} puzzle #${puzzleId}â€¦`,'warn');
  setStatus('Generatingâ€¦','yellow');
  setTimeout(()=>{
    const{puzzle,solution:sol,clues}=createPuzzle(diff);
    board=puzzle.map(r=>[...r]);
    givenMask=puzzle.map(r=>r.map(v=>v!==0));
    solution=sol;
    totalEmpty=81-clues;
    selR=-1;selC=-1;
    iterations=0;backtracks=0;solvedCells=0;finalIter=0;
    ['easy','medium','hard'].forEach(d=>{
      document.getElementById('db-'+d).className='diff-btn'+(d===diff?` sel-${d}`:'');
    });
    document.getElementById('grid').className='sudoku-grid';
    renderAll();
    updateCounterUI(0);
    updateSearchSpace(clues,totalEmpty);
    resetIATable();
    addLog(`Ready â€” ${clues} clues, ${totalEmpty} empty cells`,'acc');
    setStatus('Ready','green');
    document.getElementById('s-bt').textContent='0';
    document.getElementById('s-time').textContent='â€”';
    document.getElementById('prog-fill').style.width='0%';
    document.getElementById('prog-pct').textContent='0%';
  },20);
}

function resetToOriginal(){
  if(solving)stopSolve();
  if(!board.length)return;
  for(let r=0;r<9;r++)for(let c=0;c<9;c++)if(!givenMask[r][c])board[r][c]=0;
  iterations=0;backtracks=0;solvedCells=0;
  updateCounterUI(0);
  document.getElementById('s-bt').textContent='0';
  document.getElementById('s-time').textContent='â€”';
  document.getElementById('grid').className='sudoku-grid';
  document.getElementById('prog-fill').style.width='0%';
  document.getElementById('prog-pct').textContent='0%';
  setStatus('Reset','green');
  renderAll();
}

//  BACKTRACKING SOLVER (async animated)
async function startSolve(){
  if(solving||!board.length)return;
  solving=true;abortFlag=false;
  iterations=0;backtracks=0;solvedCells=0;
  startTime=performance.now();
  document.getElementById('btn-solve').style.display='none';
  document.getElementById('btn-stop').style.display='inline-block';
  document.getElementById('grid').classList.add('state-solving');
  setStatus('Solvingâ€¦','green');
  addLog('Backtracking started','acc');
  for(let r=0;r<9;r++)for(let c=0;c<9;c++)if(!givenMask[r][c])board[r][c]=0;
  const delay=+document.getElementById('speed-sel').value;
  const ok=await btSolve(delay);
  solving=false;
  document.getElementById('btn-solve').style.display='inline-block';
  document.getElementById('btn-stop').style.display='none';
  if(ok){
    finalIter=iterations;
    const elapsed=((performance.now()-startTime)/1000).toFixed(3);
    document.getElementById('grid').classList.remove('state-solving');
    document.getElementById('grid').classList.add('state-solved');
    document.getElementById('s-time').textContent=elapsed+'s';
    setStatus('Solved âœ“','green');
    addLog(`Solved in ${fmtNum(iterations)} iterations, ${elapsed}s`,'acc');
    updateCounterUI(iterations);
    updateProgress(totalEmpty,totalEmpty);
    updateIAPostSolve(elapsed);
    updateQuantum();
  }else if(abortFlag){
    setStatus('Stopped','yellow');addLog('Stopped by user','warn');
  }else{
    setStatus('No solution','red');addLog('No solution found','err');
  }
}

function stopSolve(){abortFlag=true}

async function btSolve(delay){
  const empties=[];
  for(let r=0;r<9;r++)for(let c=0;c<9;c++)if(!givenMask[r][c])empties.push([r,c]);
  let lastUI=0;
  async function bt(idx){
    if(abortFlag)return false;
    if(idx===empties.length)return true;
    const[r,c]=empties[idx];
    for(let n=1;n<=9;n++){
      if(abortFlag)return false;
      iterations++;
      if(isOK(board,r,c,n)){
        board[r][c]=n;solvedCells=idx+1;
        if(delay>0||(iterations-lastUI)>3000){
          lastUI=iterations;
          renderLive(r,c,n);
          updateCounterUI(iterations);
          updateProgress(idx+1,empties.length);
          document.getElementById('s-bt').textContent=fmtNum(backtracks);
          await sleep(delay);
        }
        if(await bt(idx+1))return true;
        board[r][c]=0;backtracks++;
        if(delay>0){renderLive(r,c,0);await sleep(delay)}
      }
    }
    return false;
  }
  return await bt(0);
}

function renderLive(r,c,v){
  const el=cel(r,c);
  el.className='cell'+(c===2||c===5?' rb':'')+(r===2||r===5?' bb':'');
  el.textContent=v||'';
  if(v){el.classList.add('filled');el.classList.add('anim-solve')}
}

function sleep(ms){return new Promise(res=>setTimeout(res,ms))}

//  STATS
function updateCounterUI(n){
  document.getElementById('iter-display').textContent=fmtNum(n);
  document.getElementById('ss-emp').textContent=n?fmtSci(n):'â€”';
  document.getElementById('ia-emp').textContent=n?fmtNum(n):'â€”';
}

function updateProgress(done,total){
  const pct=total?Math.round((done/total)*100):0;
  document.getElementById('prog-fill').style.width=pct+'%';
  document.getElementById('prog-pct').textContent=pct+'%';
}

function setStatus(txt,cls){
  const el=document.getElementById('s-status');el.textContent=txt;
  el.className='s-val '+cls;
}

function updateSearchSpace(clues,m){
  document.getElementById('s-m').textContent=m;
  document.getElementById('ss-diff').textContent=currentDiff.charAt(0).toUpperCase()+currentDiff.slice(1);
  document.getElementById('ss-n').textContent=clues;
  document.getElementById('ia-diff').textContent=currentDiff;
  document.getElementById('ia-n').textContent=clues;
  document.getElementById('ia-m').textContent=m;
  document.getElementById('ia-id').textContent=`P${String(puzzleId).padStart(3,'0')}-${currentDiff[0].toUpperCase()}`;
  const nupper=Math.pow(9,m),neff=Math.pow(7.5,m),classi=nupper/2;
  document.getElementById('ss-nupper').textContent=fmtSci(nupper);
  document.getElementById('ss-neff').textContent=fmtSci(neff);
  document.getElementById('ss-class').textContent=fmtSci(classi);
  document.getElementById('ia-neff2').textContent=fmtSci(neff/2);
  const theta=Math.asin(1/Math.sqrt(neff));
  const kOpt=Math.floor((Math.PI/4)*Math.sqrt(neff));
  const speedup=(neff/2)/kOpt;
  document.getElementById('qf-theta').textContent=theta.toExponential(3);
  document.getElementById('qf-k').textContent=fmtSci(kOpt);
  document.getElementById('qf-s').textContent=fmtSci(speedup);
  document.getElementById('ia-k').textContent=fmtSci(kOpt);
  document.getElementById('bar-c-lbl').textContent=fmtSci(classi);
  document.getElementById('bar-q-lbl').textContent=fmtSci(kOpt);
  const logC=Math.log10(Math.max(classi,1)),logQ=Math.log10(Math.max(kOpt,1));
  document.getElementById('bar-q').style.width=Math.max(2,Math.min(40,(logQ/logC)*100))+'%';
}

function updateQuantum(){
  if(!finalIter||!totalEmpty)return;
  const neff=Math.pow(7.5,totalEmpty);
  const kOpt=Math.floor((Math.PI/4)*Math.sqrt(neff));
  const speedup=finalIter/kOpt;
  const s=fmtSci(speedup);
  document.getElementById('qf-badge').textContent=`Empirical Ã· Grover k_opt = ${s}Ã—`;
  document.getElementById('ia-speedup').textContent=s+'Ã—';
}

function updateIAPostSolve(elapsed){
  document.getElementById('s-time').textContent=elapsed+'s';
}

function resetIATable(){
  ['ia-emp','ia-speedup'].forEach(id=>document.getElementById(id).textContent='â€”');
  document.getElementById('qf-badge').textContent='Generate and solve a puzzle to see speedup';
}

//  LOG
function addLog(msg,cls=''){
  const box=document.getElementById('log');
  const line=document.createElement('div');
  line.textContent='> '+msg;
  if(cls)line.className='l-'+cls;
  box.appendChild(line);box.scrollTop=box.scrollHeight;
  if(box.children.length>80)box.removeChild(box.firstChild);
}


 #FORMATTERS

function fmtNum(n){
  if(!isFinite(n)||n===0)return'0';
  if(n>=1e15)return fmtSci(n);
  return Math.round(n).toLocaleString();
}
function fmtSci(n){
  if(!isFinite(n)||n===0)return'0';
  if(n<1000)return n.toFixed(2);
  const e=Math.floor(Math.log10(Math.abs(n)));
  return(n/Math.pow(10,e)).toFixed(2)+'Ã—10^'+e;
}

 #INIT
buildGrid();
buildNumpad();
newPuzzle('easy');
</script>
</body>

</html>
